<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Simulados - Evoluindo com Exercicios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #001f3f;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        body.light-theme {
            background-color: #f4f7fa;
            color: #000;
        }
        header {
            background-color: #000f1f;
            color: white;
            width: 100%;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .icons {
            display: flex;
            gap: 20px;
        }
        .icon-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            animation: pulse 2s infinite;
        }
        body.light-theme .icon-btn {
            background-color: #0056b3;
            color: #fff;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .icon-btn:hover {
            background-color: #0056b3;
        }
        .theme-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.5s, background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .theme-btn:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
            transform: rotate(360deg);
        }
        body.light-theme .theme-btn {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
        }
        .container {
            max-width: 800px;
            width: 90%;
            margin: 20px auto;
            background: #001f3f;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            border: 2px solid #ffd700;
        }
        body.light-theme .container {
            background: #fff;
            border: 2px solid #007bff;
        }
        .quiz-section, .score-section, .questions-section, .settings-section {
            display: none;
        }
        .question-card {
            background: #002a5c;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        body.light-theme .question-card {
            background: #e6f0fa;
        }
        .question-card.correct {
            box-shadow: 0 0 10px 3px #28a745;
        }
        .question-card.incorrect {
            box-shadow: 0 0 10px 3px #dc3545;
        }
        .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
        }
        .question-card h3 {
            margin-bottom: 10px;
        }
        .options label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }
        #submit-quiz {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        #submit-quiz:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #submit-quiz:hover:not(:disabled) {
            background-color: #218838;
        }
        #result {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }
        #hp-bar-global {
            background: #ff0000;
            height: 20px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px auto;
            width: 90%;
            max-width: 800px;
            display: block;
            position: relative;
        }
        #timer-progress-bar {
            background: #333;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px auto;
            width: 90%;
            max-width: 800px;
            display: none;
        }
        .timer-progress {
            background: #ffd700;
            height: 100%;
            width: 100%;
            transition: width 1s linear;
        }
        .timer-text {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin: 5px 0;
            color: #ffd700;
        }
        body.light-theme .timer-text {
            color: #007bff;
        }
        .hp-progress {
            background: #00ff00;
            height: 100%;
            transition: width 0.5s;
        }
        .hp-text {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
        }
        body.light-theme .hp-text {
            background: rgba(255, 255, 255, 0.5);
        }
        .timer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        .timer-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .timer-controls button:hover {
            background: #0056b3;
        }
        .back-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .back-btn:hover {
            background: #c82333;
        }
        .delete-all-btn, .clear-cache-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .delete-all-btn:hover, .clear-cache-btn:hover {
            background: #c82333;
        }
        .reset-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.5s, background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .reset-btn:hover {
            background: linear-gradient(135deg, #c82333, #a71d2a);
            transform: rotate(360deg);
        }
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .score-chart, .pie-chart, .line-chart {
            margin: 20px 0;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            width: 45%;
            max-height: 200px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ffd700;
            padding: 10px;
            text-align: center;
            color: #fff;
        }
        body.light-theme th, body.light-theme td {
            color: #000;
        }
        th {
            background: #007bff;
        }
        .level-bar {
            background: #4b0082;
            height: 20px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .level-progress {
            background: #9370db;
            height: 100%;
            transition: width 0.5s;
        }
        .level-text {
            text-align: center;
            margin-bottom: 5px;
        }
        .start-btn, .quick-quest-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.3s, background 0.3s;
            margin-top: 20px;
        }
        .revanche-btn {
            background-color: #ff8c00;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.3s, background 0.3s;
            margin-top: 20px;
        }
        .start-btn.game-over, .quick-quest-btn.game-over, .revanche-btn.game-over {
            background-color: #dc3545;
            cursor: not-allowed;
        }
        .start-btn:hover:not(.game-over), .quick-quest-btn:hover:not(.game-over), .revanche-btn:hover:not(.game-over) {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        .revanche-btn:hover:not(.game-over) {
            background-color: #e07b00;
        }
        .game-over-message {
            color: #dc3545;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }
        .progress-text {
            margin-bottom: 10px;
            font-weight: bold;
        }
        .questions-form, .settings-form {
            margin-bottom: 20px;
        }
        .questions-form {
            display: flex;
            gap: 10px;
        }
        .settings-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .settings-form h2 {
            grid-column: 1 / -1;
            text-align: center;
        }
        .settings-form label[for="difficulty"] {
            grid-column: 1 / -1;
            text-align: center;
        }
        .difficulty-buttons {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: center;
            margin: 10px auto;
            width: 100%;
            max-width: 500px;
        }
        .difficulty-button {
            padding: 6px;
            font-size: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 80px;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .difficulty-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .difficulty-button:active {
            animation: pulse 0.2s;
        }
        .difficulty-button.selected {
            box-shadow: 0 0 0 3px #ffd700;
        }
        .difficulty-easy { background: linear-gradient(135deg, #28a745, #218838); color: #fff; }
        .difficulty-medium { background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; }
        .difficulty-hard { background: linear-gradient(135deg, #fd7e14, #e06c00); color: #fff; }
        .difficulty-expert { background: linear-gradient(135deg, #dc3545, #c82333); color: #fff; }
        .difficulty-custom { background: linear-gradient(135deg, #6c757d, #5a6268); color: #fff; }
        .settings-form .form-group {
            display: flex;
            flex-direction: column;
        }
        .settings-form input, .settings-form select {
            padding: 6px;
            font-size: 14px;
            max-width: 150px;
            border-radius: 5px;
            border: 1px solid #ffd700;
            background: #002a5c;
            color: #fff;
        }
        body.light-theme .settings-form input:not(:disabled),
        body.light-theme .settings-form select:not(:disabled) {
            background: #e6f0fa;
            color: #000;
            border: 1px solid #007bff;
        }
        .settings-form input:disabled, .settings-form select:disabled {
            background: #6c757d;
            color: #fff;
            cursor: not-allowed;
        }
        .questions-form button, .settings-form button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 14px;
            margin: 20px auto;
            display: block;
        }
        .questions-form button:hover, .settings-form button:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
            transform: scale(1.05);
        }
        body.light-theme .questions-form button, body.light-theme .settings-form button {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
        }
        .add-question-form, .edit-question-form, .import-question-form, .export-question-form, .settings-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .add-question-form label, .edit-question-form label, .import-question-form label, .settings-form label {
            font-weight: bold;
        }
        .add-question-form input, .add-question-form textarea, .add-question-form select,
        .edit-question-form input, .edit-question-form textarea, .edit-question-form select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ffd700;
            background: #002a5c;
            color: #fff;
        }
        body.light-theme .add-question-form input,
        body.light-theme .add-question-form textarea,
        body.light-theme .add-question-form select,
        body.light-theme .edit-question-form input,
        body.light-theme .edit-question-form textarea,
        body.light-theme .edit-question-form select {
            background: #e6f0fa;
            color: #000;
            border: 1px solid #007bff;
        }
        .add-question-form button, .edit-question-form button, .import-question-form button, .export-question-form button, .settings-form button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .add-question-form button:hover, .edit-question-form button:hover, .import-question-form button:hover, .export-question-form button:hover, .settings-form button:hover {
            background-color: #218838;
        }
        .question-bank-list .question-card {
            position: relative;
        }
        .question-bank-list .question-card .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .question-bank-list .question-card .actions button {
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .question-bank-list .question-card .actions .edit-btn {
            background-color: #007bff;
            color: white;
            border: none;
        }
        .question-bank-list .question-card .actions .edit-btn:hover {
            background-color: #0056b3;
        }
        .question-bank-list .question-card .actions .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        .question-bank-list .question-card .actions .delete-btn:hover {
            background-color: #c82333;
        }
        .import-question-form input[type="file"] {
            display: none;
        }
        .import-question-form .custom-file-upload {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s, background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .import-question-form .custom-file-upload:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: scale(1.05);
        }
        body.light-theme .import-question-form .custom-file-upload {
            background: linear-gradient(135deg, #adb5bd, #6c757d);
        }
        .import-question-form #file-name-display {
            margin-top: 10px;
            font-size: 14px;
            color: #ffd700;
        }
        body.light-theme .import-question-form #file-name-display {
            color: #007bff;
        }
        .import-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .download-template-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            font-size: 14px;
        }
        .download-template-btn:hover {
            background: linear-gradient(135deg, #138496, #0c6b7a);
            transform: scale(1.05);
        }
        .save-slot-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .save-slot-card {
            background: #002a5c;
            padding: 15px;
            border-radius: 8px;
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
            animation: cardPulse 1.5s infinite;
        }
        body.light-theme .save-slot-card {
            background: #e6f0fa;
        }
        .save-slot-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
        }
        @keyframes cardPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .save-slot-card.empty {
            background: #333;
            opacity: 0.7;
        }
        body.light-theme .save-slot-card.empty {
            background: #ccc;
        }
        .save-slot-card .delete-slot-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
            display: none;
        }
        .save-slot-card:hover .delete-slot-btn {
            display: flex;
        }
        .save-slot-card .delete-slot-btn:hover {
            background: #c82333;
        }
        .save-continue-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .save-btn, .continue-btn {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
        }
        .save-btn:hover, .continue-btn:hover {
            background: linear-gradient(135deg, #218838, #1c7430);
            transform: scale(1.05);
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px; /* Reduz o espaçamento entre botões */
            margin-top: 20px;
            flex-wrap: wrap;
            max-width: 100%; /* Garante que a paginação não ultrapasse o contêiner */
            overflow-x: auto; /* Adiciona rolagem horizontal se necessário */
            padding: 10px;
        }
        
        .pagination button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 6px 12px; /* Reduz o padding para botões menores */
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s, background 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 12px; /* Reduz o tamanho da fonte */
            min-width: 40px; /* Garante um tamanho mínimo para os botões */
        }
        
        .pagination button:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
            transform: scale(1.05);
        }
        
        .pagination button.active {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            box-shadow: 0 0 0 3px #ffd700;
        }
        
        .pagination button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* Estilos para tema claro */
        body.light-theme .pagination button {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
        }
        
        body.light-theme .pagination button:hover {
            background: linear-gradient(135deg, #ff8c00, #e07b00);
        }
        
        body.light-theme .pagination button.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            box-shadow: 0 0 0 3px #007bff;
        }
        @media (max-width: 600px) {
            .container {
                width: 95%;
                padding: 15px;
            }
            .score-chart, .pie-chart, .line-chart {
                width: 100%;
                max-height: 150px;
            }
            header {
                flex-direction: column;
                align-items: center;
            }
            .icons {
                margin-top: 10px;
            }
            .theme-btn {
                margin-top: 10px;
            }
            .questions-form {
                flex-direction: column;
            }
            .settings-form {
                grid-template-columns: 1fr;
            }
            .difficulty-buttons {
                flex-direction: column;
            }
            .import-actions {
                flex-direction: column;
                align-items: center;
            }
            .save-slot-card {
                width: 100%;
            }
            .pagination {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
        function clearCache() {
            if (confirm('Tem certeza que deseja apagar todos os dados de cache do site? Esta ação não pode ser desfeita.')) {
                localStorage.clear();
                questionBank = [];
                wrongQuestions = [];
                scores = [];
                currentHP = settings.maxHP;
                currentLevel = 0;
                totalXP = 0;
                isGameOver = false;
                savedGames = Array(8).fill(null);
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                localStorage.setItem('rpgScores', JSON.stringify(scores));
                localStorage.setItem('currentHP', JSON.stringify(currentHP));
                localStorage.setItem('currentLevel', JSON.stringify(currentLevel));
                localStorage.setItem('totalXP', JSON.stringify(totalXP));
                localStorage.setItem('savedGames', JSON.stringify(savedGames));
                alert('Cache apagado com sucesso! A página será recarregada.');
                location.reload();
            }
        }
    </script>
    <header>
        <h1>Simulados - Evoluindo com Exercicios</h1>
        <div class="icons">
            <button class="icon-btn" onclick="showMenu()" aria-label="Abrir Menu Principal"><i class="fas fa-home"></i> Menu</button>
            <button class="icon-btn" onclick="showScore()" aria-label="Ver Pontuação"><i class="fas fa-trophy"></i> Score</button>
            <button class="icon-btn" onclick="showQuestions()" aria-label="Questões"><i class="fas fa-plus-circle"></i> Questões</button>
            <button class="icon-btn" onclick="showSettings()" aria-label="Configurações"><i class="fas fa-cog"></i> Configurações</button>
            <button class="theme-btn" onclick="toggleTheme()" aria-label="Alternar Tema"><i class="fas fa-sun"></i></button>
        </div>
    </header>

    <div id="hp-bar-global"><div class="hp-progress" style="width: 100%;"></div><span class="hp-text">HP: 100/100</span></div>
    <div id="timer-progress-bar"><div class="timer-progress"></div></div>
    <div class="timer-text">Tempo restante: <span id="timer">Aguardando</span></div>
    <div class="timer-controls" style="display: none;">
        <button onclick="toggleTimer()" aria-label="Pausar/Retomar Temporizador">Pausar</button>
    </div>

    <div class="container" id="main-menu">
        <h2>Bem vindo, Inicie o modo de jogo!</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button id="start-btn" class="start-btn" onclick="startQuiz()">Iniciar Quest</button>
            <button id="quick-quest-btn" class="quick-quest-btn" onclick="startQuickQuest()">Quest Rápida</button>
            <button id="revanche-btn" class="revanche-btn" onclick="startRevancheQuiz()">Revanche</button>
            <span id="game-over-message" class="game-over-message" style="display: none;">Reinicie seu score para continuar</span>
        </div>
    </div>

    <div class="container" id="quiz-container" style="display: none;">
        <h2>Desafio de Conhecimento</h2>
        <div class="progress-text">Questão: <span id="question-progress">1</span> de <span id="total-questions"></span></div>
        <form id="quiz-form">
            <!-- Questões inseridas via JS -->
        </form>
        <button id="submit-quiz" type="submit" form="quiz-form">Enviar Respostas</button>
        <div id="result"></div>
        <button class="back-btn" onclick="backToMenu()">Voltar ao Menu Principal</button>
    </div>

    <div class="container" id="score-container" style="display: none;">
        <h2>Seu Progresso RPG</h2>
        <div class="save-continue-buttons">
            <button class="save-btn" onclick="showSaveSlots()">Salvar Jogo</button>
            <button class="continue-btn" onclick="showLoadSlots()">Continuar Jogo</button>
        </div>
        <div id="save-slot-section" class="save-slot-container" style="display: none;"></div>
        <p>Histórico de Quests Completadas</p>
        <table id="score-table">
            <thead>
                <tr>
                    <th>Quest</th>
                    <th>Acertos</th>
                    <th>Total</th>
                    <th>Pontos RPG</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="level-text">Nível: <span id="level">0</span> - Progresso para Próximo Nível</div>
        <div class="level-bar"><div id="level-progress" class="level-progress" style="width: 0%;"></div></div>
        <div class="charts-container">
            <div class="pie-chart">
                <canvas id="pieChart"></canvas>
            </div>
            <div class="line-chart">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
        <button class="back-btn" onclick="backToMenu()">Voltar ao Menu Principal</button>
        <button class="reset-btn" onclick="resetScores()" aria-label="Resetar Progresso"><i class="fas fa-sync-alt"></i></button>
    </div>

    <div class="container questions-section" id="questions-container" style="display: none;">
        <h2>Questões</h2>
        <div class="questions-form">
            <button onclick="toggleQuestionsMode('add')">Adicionar</button>
            <button onclick="toggleQuestionsMode('bank')">Banco de Questões</button>
            <button onclick="toggleQuestionsMode('import')">Importar</button>
            <button onclick="toggleQuestionsMode('export')">Exportar</button>
        </div>
        <div id="add-question-section">
            <form id="add-question-form" class="add-question-form">
                <label for="question-text">Pergunta:</label>
                <textarea id="question-text" name="question-text" required></textarea>
                <label for="option-a">Opção A:</label>
                <input type="text" id="option-a" name="option-a" required>
                <label for="option-b">Opção B:</label>
                <input type="text" id="option-b" name="option-b" required>
                <label for="option-c">Opção C:</label>
                <input type="text" id="option-c" name="option-c" required>
                <label for="option-d">Opção D:</label>
                <input type="text" id="option-d" name="option-d" required>
                <label for="correct-answer">Alternativa Correta:</label>
                <select id="correct-answer" name="correct-answer" required>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <button type="submit">Adicionar Questão</button>
            </form>
        </div>
        <div id="question-bank-section" style="display: none;">
            <h3>Banco de Questões</h3>
            <div id="question-bank-list" class="question-bank-list"></div>
            <div class="pagination" id="pagination"></div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="back-btn" onclick="backToMenu()">Voltar ao Menu Principal</button>
                <button class="delete-all-btn" onclick="deleteAllQuestions()"><i class="fas fa-trash"></i> Apagar Tudo</button>
            </div>
        </div>
        <div id="import-question-section" style="display: none;">
            <h3>Importar Questões</h3>
            <form id="import-question-form" class="import-question-form">
                <label for="question-file" class="custom-file-upload">
                    <i class="fas fa-upload"></i> Escolher Arquivo
                </label>
                <input type="file" id="question-file" name="question-file" accept=".xlsx" required>
                <span id="file-name-display">Nenhum arquivo selecionado</span>
                <div class="import-actions">
                    <button type="submit">Importar</button>
                    <button class="download-template-btn" onclick="downloadTemplate()">Baixar Modelo</button>
                </div>
            </form>
        </div>
        <div id="export-question-section" style="display: none;">
            <h3>Exportar Questões</h3>
            <form id="export-question-form" class="export-question-form">
                <button type="button" onclick="exportQuestions()">Download Questões</button>
            </form>
        </div>
        <div id="edit-question-section" style="display: none;">
            <h3>Editar Questão</h3>
            <form id="edit-question-form" class="edit-question-form">
                <input type="hidden" id="edit-question-index">
                <label for="edit-question-text">Pergunta:</label>
                <textarea id="edit-question-text" name="edit-question-text" required></textarea>
                <label for="edit-option-a">Opção A:</label>
                <input type="text" id="edit-option-a" name="edit-option-a" required>
                <label for="edit-option-b">Opção B:</label>
                <input type="text" id="edit-option-b" name="edit-option-b" required>
                <label for="edit-option-c">Opção C:</label>
                <input type="text" id="edit-option-c" name="edit-option-c" required>
                <label for="edit-option-d">Opção D:</label>
                <input type="text" id="edit-option-d" name="edit-option-d" required>
                <label for="edit-correct-answer">Alternativa Correta:</label>
                <select id="edit-correct-answer" name="edit-correct-answer" required>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                </select>
                <button type="submit">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <div class="container settings-section" id="settings-container" style="display: none;">
        <h2>Configurações</h2>
        <form id="settings-form" class="settings-form">
            <div class="form-group">
                <label for="difficulty">Nível de Dificuldade:</label>
                <input type="hidden" id="difficulty" name="difficulty">
                <div class="difficulty-buttons">
                    <button type="button" class="difficulty-button difficulty-easy" data-difficulty="easy">Fácil</button>
                    <button type="button" class="difficulty-button difficulty-medium" data-difficulty="medium">Médio</button>
                    <button type="button" class="difficulty-button difficulty-hard" data-difficulty="hard">Difícil</button>
                    <button type="button" class="difficulty-button difficulty-expert" data-difficulty="expert">Expert</button>
                    <button type="button" class="difficulty-button difficulty-custom" data-difficulty="custom">Custom</button>
                </div>
            </div>
            <div class="form-group">
                <label for="questions-per-quest">Questões por Quest:</label>
                <input type="number" id="questions-per-quest" name="questions-per-quest" min="1" required>
            </div>
            <div class="form-group">
                <label for="xp-per-correct-answer">XP por Resposta Correta:</label>
                <input type="number" id="xp-per-correct-answer" name="xp-per-correct-answer" min="1" required>
            </div>
            <div class="form-group">
                <label for="hp-loss-per-wrong-answer">HP Perdido por Erro:</label>
                <input type="number" id="hp-loss-per-wrong-answer" name="hp-loss-per-wrong-answer" min="0" required>
            </div>
            <div class="form-group">
                <label for="time-per-quest">Tempo por Quest (minutos):</label>
                <input type="number" id="time-per-quest" name="time-per-quest" min="1" required>
            </div>
            <div class="form-group">
                <label for="quick-quest-time">Tempo por Quest Rápida (segundos):</label>
                <input type="number" id="quick-quest-time" name="quick-quest-time" min="1" required>
            </div>
            <button type="submit">Salvar Configurações</button>
        </form>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="back-btn" onclick="backToMenu()">Voltar ao Menu Principal</button>
            <button class="clear-cache-btn" onclick="clearCache()"><i class="fas fa-trash"></i> Apagar Cache</button>
        </div>
    </div>

    <script>
        // Configurações padrão
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            difficulty: 'easy',
            questionsPerQuest: 5,
            xpPerCorrectAnswer: 10,
            hpLossPerWrongAnswer: 5,
            timePerQuest: 10,
            quickQuestTime: {
                easy: 120,
                medium: 90,
                hard: 60,
                expert: 30,
                custom: 30
            },
            baseXPToLevelUp: 100,
            xpIncrementPerLevel: 10,
            maxHP: 100
        };

        // Banco de questões
        let questionBank = JSON.parse(localStorage.getItem('questionBank')) || [
            { text: "Exemplo 1", options: ["Opção A", "Opção B", "Opção C", "Opção D"], answer: "A" }
        ];

        // Banco de questões erradas
        let wrongQuestions = JSON.parse(localStorage.getItem('wrongQuestions')) || [];

        let currentQuestions = [];
        let timerInterval;
        let timeLeft = settings.timePerQuest * 60;
        let totalTime = settings.timePerQuest * 60;
        let scores = JSON.parse(localStorage.getItem('rpgScores')) || [];
        let currentHP = JSON.parse(localStorage.getItem('currentHP')) || settings.maxHP;
        let currentLevel = JSON.parse(localStorage.getItem('currentLevel')) || 0;
        let totalXP = JSON.parse(localStorage.getItem('totalXP')) || 0;
        let isTimerPaused = false;
        let currentAnswers = {};
        let quizId = null;
        let pieChartInstance = null;
        let lineChartInstance = null;
        let savedGames = JSON.parse(localStorage.getItem('savedGames')) || Array(8).fill(null);
        let isGameOver = currentHP <= 0;
        let isRevancheMode = false;
        let isQuickQuestMode = false;
        let currentPage = 1;
        const questionsPerPage = 10;

        // Initialize game state
        function initializeGame() {
            console.log('Initializing game state...');
            if (!questionBank.length) {
                questionBank = [{ text: "Exemplo 1", options: ["Opção A", "Opção B", "Opção C", "Opção D"], answer: "A" }];
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
            }
            if (currentHP <= 0) {
                currentHP = settings.maxHP;
                isGameOver = false;
                localStorage.setItem('currentHP', JSON.stringify(currentHP));
            }
            updateStartButton();
            updateHPBar();
        }

        function updateStartButton() {
            console.log('Updating start button... isGameOver:', isGameOver, 'wrongQuestions.length:', wrongQuestions.length);
            const startBtn = document.getElementById('start-btn');
            const quickQuestBtn = document.getElementById('quick-quest-btn');
            const revancheBtn = document.getElementById('revanche-btn');
            const gameOverMessage = document.getElementById('game-over-message');
            if (startBtn && quickQuestBtn && revancheBtn && gameOverMessage) {
                if (isGameOver) {
                    console.log('Game is over, disabling buttons');
                    startBtn.textContent = 'Game Over';
                    quickQuestBtn.textContent = 'Game Over';
                    startBtn.classList.add('game-over');
                    quickQuestBtn.classList.add('game-over');
                    startBtn.disabled = true;
                    quickQuestBtn.disabled = true;
                    revancheBtn.style.display = 'none';
                    gameOverMessage.style.display = 'inline-block';
                } else {
                    console.log('Game is active, enabling buttons');
                    startBtn.textContent = 'Iniciar Quest';
                    quickQuestBtn.textContent = 'Quest Rápida';
                    startBtn.classList.remove('game-over');
                    quickQuestBtn.classList.remove('game-over');
                    startBtn.disabled = false;
                    quickQuestBtn.disabled = false;
                    revancheBtn.style.display = wrongQuestions.length > 0 ? 'inline-block' : 'none';
                    gameOverMessage.style.display = 'none';
                }
            } else {
                console.error('Missing DOM elements for start button update:', { startBtn, quickQuestBtn, revancheBtn, gameOverMessage });
            }
        }

        function showMenu() {
            console.log('Showing main menu...');
            document.getElementById('main-menu').style.display = 'block';
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('score-container').style.display = 'none';
            document.getElementById('questions-container').style.display = 'none';
            document.getElementById('settings-container').style.display = 'none';
            document.getElementById('save-slot-section').style.display = 'none';
            stopTimer();
            updateHPBar();
            updateStartButton();
        }

        function showScore() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('score-container').style.display = 'block';
            document.getElementById('questions-container').style.display = 'none';
            document.getElementById('settings-container').style.display = 'none';
            document.getElementById('save-slot-section').style.display = 'none';
            renderScores();
            stopTimer();
            updateHPBar();
        }

        function showQuestions() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('score-container').style.display = 'none';
            document.getElementById('questions-container').style.display = 'block';
            document.getElementById('settings-container').style.display = 'none';
            toggleQuestionsMode('add');
            stopTimer();
            updateHPBar();
        }

        function showSettings() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('score-container').style.display = 'none';
            document.getElementById('questions-container').style.display = 'none';
            document.getElementById('settings-container').style.display = 'block';
            loadSettings();
            stopTimer();
            updateHPBar();
        }

        function toggleQuestionsMode(mode) {
            const addSection = document.getElementById('add-question-section');
            const bankSection = document.getElementById('question-bank-section');
            const importSection = document.getElementById('import-question-section');
            const exportSection = document.getElementById('export-question-section');
            const editSection = document.getElementById('edit-question-section');
            if (addSection && bankSection && importSection && exportSection && editSection) {
                addSection.style.display = mode === 'add' ? 'block' : 'none';
                bankSection.style.display = mode === 'bank' ? 'block' : 'none';
                importSection.style.display = mode === 'import' ? 'block' : 'none';
                exportSection.style.display = mode === 'export' ? 'block' : 'none';
                editSection.style.display = 'none';
                if (mode === 'bank') {
                    currentPage = 1;
                    renderQuestionBank();
                }
            }
        }

        function backToMenu() {
            const form = document.getElementById('quiz-form');
            if (form) {
                Array.from(form.querySelectorAll('input[type="radio"]:checked')).forEach(input => {
                    currentAnswers[input.name] = input.value;
                });
                localStorage.setItem(`quizState_${quizId}`, JSON.stringify(currentAnswers));
            }
            showMenu();
        }

        function loadSettings() {
            const difficulty = document.getElementById('difficulty');
            const questionsPerQuest = document.getElementById('questions-per-quest');
            const xpPerCorrectAnswer = document.getElementById('xp-per-correct-answer');
            const hpLossPerWrongAnswer = document.getElementById('hp-loss-per-wrong-answer');
            const timePerQuest = document.getElementById('time-per-quest');
            const quickQuestTime = document.getElementById('quick-quest-time');

            if (difficulty && questionsPerQuest && xpPerCorrectAnswer && hpLossPerWrongAnswer && timePerQuest && quickQuestTime) {
                difficulty.value = settings.difficulty;
                questionsPerQuest.value = settings.questionsPerQuest;
                xpPerCorrectAnswer.value = settings.xpPerCorrectAnswer;
                hpLossPerWrongAnswer.value = settings.hpLossPerWrongAnswer;
                timePerQuest.value = settings.timePerQuest;
                quickQuestTime.value = settings.quickQuestTime[settings.difficulty] || settings.quickQuestTime.custom;

                updateDifficultyButtons();
                updateDifficulty();
            }
        }

        function updateDifficultyButtons() {
            const buttons = document.querySelectorAll('.difficulty-button');
            const difficultyInput = document.getElementById('difficulty');
            buttons.forEach(button => {
                button.classList.remove('selected');
                if (button.dataset.difficulty === difficultyInput.value) {
                    button.classList.add('selected');
                }
            });
        }

        function saveSettings(event) {
            event.preventDefault();
            const difficulty = document.getElementById('difficulty').value;
            const questionsPerQuest = parseInt(document.getElementById('questions-per-quest').value);
            const xpPerCorrectAnswer = parseInt(document.getElementById('xp-per-correct-answer').value);
            const hpLossPerWrongAnswer = parseInt(document.getElementById('hp-loss-per-wrong-answer').value);
            const timePerQuest = parseInt(document.getElementById('time-per-quest').value);
            const quickQuestTime = parseInt(document.getElementById('quick-quest-time').value);

            if (isNaN(questionsPerQuest) || isNaN(xpPerCorrectAnswer) || isNaN(hpLossPerWrongAnswer) || isNaN(timePerQuest) || isNaN(quickQuestTime) ||
                questionsPerQuest < 1 || xpPerCorrectAnswer < 1 || hpLossPerWrongAnswer < 0 || timePerQuest < 1 || quickQuestTime < 1) {
                alert('Por favor, insira valores válidos (números positivos, exceto HP perdido que pode ser 0).');
                return;
            }

            settings = {
                difficulty,
                questionsPerQuest,
                xpPerCorrectAnswer,
                hpLossPerWrongAnswer,
                timePerQuest,
                quickQuestTime: {
                    easy: settings.quickQuestTime.easy || 120,
                    medium: settings.quickQuestTime.medium || 90,
                    hard: settings.quickQuestTime.hard || 60,
                    expert: settings.quickQuestTime.expert || 30,
                    custom: quickQuestTime
                },
                baseXPToLevelUp: 100,
                xpIncrementPerLevel: 10,
                maxHP: 100
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            if (currentHP > settings.maxHP) {
                currentHP = settings.maxHP;
                isGameOver = false;
                localStorage.setItem('currentHP', JSON.stringify(currentHP));
            }
            updateLevelAndHP();
            updateHPBar();
            updateStartButton();
            alert('Configurações salvas com sucesso!');
            showMenu();
        }

        function updateDifficulty() {
            const difficulty = document.getElementById('difficulty').value;
            const questionsPerQuest = document.getElementById('questions-per-quest');
            const xpPerCorrectAnswer = document.getElementById('xp-per-correct-answer');
            const hpLossPerWrongAnswer = document.getElementById('hp-loss-per-wrong-answer');
            const timePerQuest = document.getElementById('time-per-quest');
            const quickQuestTime = document.getElementById('quick-quest-time');

            const configs = {
                easy: { questionsPerQuest: 5, xpPerCorrectAnswer: 10, hpLossPerWrongAnswer: 5, timePerQuest: 10, quickQuestTime: 120 },
                medium: { questionsPerQuest: 10, xpPerCorrectAnswer: 7, hpLossPerWrongAnswer: 7, timePerQuest: 15, quickQuestTime: 90 },
                hard: { questionsPerQuest: 20, xpPerCorrectAnswer: 5, hpLossPerWrongAnswer: 8, timePerQuest: 20, quickQuestTime: 60 },
                expert: { questionsPerQuest: 30, xpPerCorrectAnswer: 3, hpLossPerWrongAnswer: 10, timePerQuest: 25, quickQuestTime: 30 },
                custom: {
                    questionsPerQuest: settings.questionsPerQuest,
                    xpPerCorrectAnswer: settings.xpPerCorrectAnswer,
                    hpLossPerWrongAnswer: settings.hpLossPerWrongAnswer,
                    timePerQuest: settings.timePerQuest,
                    quickQuestTime: settings.quickQuestTime.custom || 30
                }
            };

            const config = configs[difficulty];
            questionsPerQuest.value = config.questionsPerQuest;
            xpPerCorrectAnswer.value = config.xpPerCorrectAnswer;
            hpLossPerWrongAnswer.value = config.hpLossPerWrongAnswer;
            timePerQuest.value = config.timePerQuest;
            quickQuestTime.value = config.quickQuestTime;

            if (difficulty !== 'custom') {
                questionsPerQuest.disabled = true;
                xpPerCorrectAnswer.disabled = true;
                hpLossPerWrongAnswer.disabled = true;
                timePerQuest.disabled = true;
                quickQuestTime.disabled = true;
            } else {
                questionsPerQuest.disabled = false;
                xpPerCorrectAnswer.disabled = false;
                hpLossPerWrongAnswer.disabled = false;
                timePerQuest.disabled = false;
                quickQuestTime.disabled = false;
            }
        }

        function updateLevelAndHP() {
            let newLevel = 0;
            let tempXP = totalXP;
            let xpForPreviousLevels = 0;

            while (tempXP >= (settings.baseXPToLevelUp + newLevel * settings.xpIncrementPerLevel)) {
                xpForPreviousLevels += settings.baseXPToLevelUp + newLevel * settings.xpIncrementPerLevel;
                tempXP -= settings.baseXPToLevelUp + newLevel * settings.xpIncrementPerLevel;
                newLevel++;
            }

            if (newLevel > currentLevel) {
                currentHP = settings.maxHP;
                isGameOver = false;
            }
            currentLevel = newLevel;
            currentHP = Math.max(0, Math.min(currentHP, settings.maxHP));
            isGameOver = currentHP <= 0;

            localStorage.setItem('currentLevel', JSON.stringify(currentLevel));
            localStorage.setItem('totalXP', JSON.stringify(totalXP));
            localStorage.setItem('currentHP', JSON.stringify(currentHP));
            localStorage.setItem('xpForPreviousLevels', JSON.stringify(xpForPreviousLevels));
            updateStartButton();
        }

        function startQuiz() {
            console.log('Starting quiz... isGameOver:', isGameOver, 'questionBank:', questionBank);
            if (isGameOver) {
                console.log('Cannot start quiz: Game Over');
                alert('Game Over! Reinicie seu score para continuar.');
                return;
            }
            if (questionBank.length === 0) {
                console.log('Cannot start quiz: No questions available');
                alert('Nenhuma questão disponível. Adicione questões primeiro.');
                return;
            }
            quizId = Date.now();
            isRevancheMode = false;
            isQuickQuestMode = false;
            currentQuestions = questionBank.sort(() => Math.random() - 0.5).slice(0, Math.min(settings.questionsPerQuest, questionBank.length));
            currentAnswers = JSON.parse(localStorage.getItem(`quizState_${quizId}`)) || {};
            console.log('currentQuestions:', currentQuestions);
            updateHPBar();
            renderQuiz();
        }

        function startQuickQuest() {
            console.log('Starting quick quest... isGameOver:', isGameOver, 'questionBank:', questionBank);
            if (isGameOver) {
                console.log('Cannot start quick quest: Game Over');
                alert('Game Over! Reinicie seu score para continuar.');
                return;
            }
            if (questionBank.length === 0) {
                console.log('Cannot start quick quest: No questions available');
                alert('Nenhuma questão disponível. Adicione questões primeiro.');
                return;
            }
            quizId = Date.now();
            isRevancheMode = false;
            isQuickQuestMode = true;
            currentQuestions = questionBank.sort(() => Math.random() - 0.5).slice(0, 1);
            currentAnswers = JSON.parse(localStorage.getItem(`quizState_${quizId}`)) || {};
            console.log('currentQuestions for quick quest:', currentQuestions);
            updateHPBar();
            renderQuiz();
        }

        function startRevancheQuiz() {
            console.log('Starting revanche quiz... isGameOver:', isGameOver, 'wrongQuestions:', wrongQuestions);
            if (isGameOver) {
                console.log('Cannot start revanche quiz: Game Over');
                alert('Game Over! Reinicie seu score para continuar.');
                return;
            }
            if (wrongQuestions.length === 0) {
                console.log('Cannot start revanche quiz: No wrong questions');
                alert('Nenhuma questão errada disponível para revanche.');
                return;
            }
            quizId = Date.now();
            isRevancheMode = true;
            isQuickQuestMode = false;
            const shuffledWrongQuestions = wrongQuestions.sort(() => Math.random() - 0.5);
            currentQuestions = shuffledWrongQuestions.slice(0, Math.min(settings.questionsPerQuest, shuffledWrongQuestions.length));
            currentAnswers = JSON.parse(localStorage.getItem(`quizState_${quizId}`)) || {};
            console.log('currentQuestions for revanche:', currentQuestions);
            updateHPBar();
            renderQuiz();
        }

        function renderQuiz() {
            console.log('Rendering quiz...');
            const form = document.getElementById('quiz-form');
            const questionProgress = document.getElementById('question-progress');
            const totalQuestions = document.getElementById('total-questions');
            const submitQuiz = document.getElementById('submit-quiz');
            const result = document.getElementById('result');
            const timerProgressBar = document.getElementById('timer-progress-bar');
            const timerControls = document.querySelector('.timer-controls');

            if (form && questionProgress && totalQuestions && submitQuiz && result && timerProgressBar && timerControls) {
                console.log('All DOM elements found, rendering questions...');
                form.innerHTML = '';
                questionProgress.textContent = '1';
                totalQuestions.textContent = currentQuestions.length;
                submitQuiz.disabled = false;
                result.style.display = 'none';

                currentQuestions.forEach((q, i) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question-card');
                    questionDiv.innerHTML = `
                        <h3>${i + 1}. ${q.text}</h3>
                        <div class="options"></div>
                    `;
                    const optionsDiv = questionDiv.querySelector('.options');

                    ['A', 'B', 'C', 'D'].forEach((label, j) => {
                        if (q.options[j]) {
                            const checked = currentAnswers[`q${i}`] === label ? 'checked' : '';
                            optionsDiv.innerHTML += `
                                <label>
                                    <input type="radio" name="q${i}" value="${label}" ${checked} aria-label="Opção ${label}: ${q.options[j]}" required>
                                    ${label}) ${q.options[j]}
                                </label>
                            `;
                        }
                    });

                    form.appendChild(questionDiv);
                });

                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                document.getElementById('score-container').style.display = 'none';
                document.getElementById('questions-container').style.display = 'none';
                document.getElementById('settings-container').style.display = 'none';
                document.getElementById('save-slot-section').style.display = 'none';
                timerProgressBar.style.display = 'block';
                timerControls.style.display = 'flex';
                const timeToUse = isQuickQuestMode ? (settings.quickQuestTime[settings.difficulty] || settings.quickQuestTime.custom || 30) : settings.timePerQuest * 60;
                startTimer(timeToUse);
            } else {
                console.error('Missing DOM elements:', { form, questionProgress, totalQuestions, submitQuiz, result, timerProgressBar, timerControls });
            }
        }

        function updateHPBar() {
            const progress = document.querySelector('.hp-progress');
            const hpText = document.querySelector('.hp-text');
            if (progress && hpText) {
                progress.style.width = `${(currentHP / settings.maxHP) * 100}%`;
                hpText.textContent = `HP: ${currentHP}/${settings.maxHP}`;
            }
            localStorage.setItem('currentHP', JSON.stringify(currentHP));
            updateStartButton();
        }

        function submitQuiz(event) {
            event.preventDefault();
            const form = document.getElementById('quiz-form');
            const result = document.getElementById('result');
            const submitQuiz = document.getElementById('submit-quiz');

            if (!form || !result || !submitQuiz) return;

            if (submitQuiz.disabled) {
                alert('Este quiz já foi enviado.');
                return;
            }

            if (isGameOver || currentHP <= 0) {
                result.textContent = 'Game Over! Seu HP chegou a zero. Reinicie o progresso para continuar.';
                result.style.display = 'block';
                submitQuiz.disabled = true;
                stopTimer();
                backToMenu();
                return;
            }

            if (!form.checkValidity()) {
                alert('Por favor, responda todas as questões antes de enviar.');
                form.reportValidity();
                return;
            }

            let score = 0;
            let errors = 0;
            let hpLost = 0;
            let correctIndices = [];

            Array.from(form.querySelectorAll('input[type="radio"]:checked')).forEach(input => {
                currentAnswers[input.name] = input.value;
            });

            const questionCards = form.querySelectorAll('.question-card');
            currentQuestions.forEach((q, i) => {
                const selected = currentAnswers[`q${i}`];
                const card = questionCards[i];
                if (selected) {
                    if (selected === q.answer) {
                        score++;
                        card.classList.add('correct');
                        if (isRevancheMode) {
                            correctIndices.push(i);
                        }
                    } else {
                        errors++;
                        currentHP -= settings.hpLossPerWrongAnswer;
                        hpLost += settings.hpLossPerWrongAnswer;
                        card.classList.add('incorrect');
                        if (!isRevancheMode) {
                            if (!wrongQuestions.some(wq => wq.text === q.text && wq.options.join() === q.options.join() && wq.answer === q.answer)) {
                                wrongQuestions.push(q);
                            }
                        }
                    }
                }
            });

            if (isRevancheMode) {
                correctIndices.sort((a, b) => b - a).forEach(index => {
                    wrongQuestions.splice(wrongQuestions.findIndex(wq =>
                        wq.text === currentQuestions[index].text &&
                        wq.options.join() === currentQuestions[index].options.join() &&
                        wq.answer === currentQuestions[index].answer
                    ), 1);
                });
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
            } else {
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
            }

            const xpMultiplier = isQuickQuestMode ? 1.5 : 1;
            totalXP += score * settings.xpPerCorrectAnswer * xpMultiplier;
            updateLevelAndHP();
            updateHPBar();

            if (isGameOver || currentHP <= 0) {
                result.textContent = 'Game Over! Seu HP chegou a zero. Reinicie o progresso para continuar.';
                result.style.display = 'block';
                submitQuiz.disabled = true;
                stopTimer();
                backToMenu();
                return;
            }

            let resultText = '';
            if (errors > 0) {
                resultText += `Você errou ${errors} questões e perdeu ${hpLost} de HP.<br>`;
            }
            resultText += `Você acertou ${score} alternativas de ${currentQuestions.length}!`;
            resultText += isQuickQuestMode ? `<br>Ganhou ${score * settings.xpPerCorrectAnswer * 1.5} XP (bônus de 50%)!` : `<br>Ganhou ${score * settings.xpPerCorrectAnswer} XP!`;
            result.innerHTML = resultText;
            result.style.display = 'block';
            submitQuiz.disabled = true;

            if (!isQuickQuestMode && !isRevancheMode) {
                scores.push({ quiz: `Quest ${scores.length + 1}`, score, total: currentQuestions.length, xp: score * settings.xpPerCorrectAnswer });
                localStorage.setItem('rpgScores', JSON.stringify(scores));
            }

            localStorage.removeItem(`quizState_${quizId}`);
            stopTimer();
        }

        function startTimer(seconds) {
            timeLeft = seconds;
            totalTime = seconds;
            const timerProgressBar = document.getElementById('timer-progress-bar');
            const timerProgress = document.querySelector('.timer-progress');
            const timerText = document.getElementById('timer');
            const timerControls = document.querySelector('.timer-controls');
            const result = document.getElementById('result');
            const submitQuiz = document.getElementById('submit-quiz');

            if (timerProgressBar && timerProgress && timerText && timerControls && result && submitQuiz) {
                timerProgressBar.style.display = 'block';
                timerControls.style.display = 'flex';
                timerProgress.style.width = '100%';
                timerText.textContent = `${Math.floor(seconds / 60)}:${(seconds % 60).toString().padStart(2, '0')}`;
                timerInterval = setInterval(() => {
                    if (!isTimerPaused) {
                        timeLeft--;
                        const percentage = (timeLeft / totalTime) * 100;
                        timerProgress.style.width = `${percentage}%`;
                        const min = Math.floor(timeLeft / 60);
                        const sec = timeLeft % 60;
                        timerText.textContent = `${min}:${sec < 10 ? '0' : ''}${sec}`;
                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            if (currentLevel > 0) {
                                currentLevel--;
                            }
                            currentHP = Math.max(0, currentHP - Math.floor(settings.maxHP * 0.35));
                            isGameOver = currentHP <= 0;
                            localStorage.setItem('currentLevel', JSON.stringify(currentLevel));
                            localStorage.setItem('currentHP', JSON.stringify(currentHP));
                            updateHPBar();
                            result.textContent = 'Game Over! Tempo esgotado.';
                            result.style.display = 'block';
                            submitQuiz.disabled = true;
                            localStorage.removeItem(`quizState_${quizId}`);
                            backToMenu();
                        }
                    }
                }, 1000);
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const timerProgressBar = document.getElementById('timer-progress-bar');
            const timerControls = document.querySelector('.timer-controls');
            if (timerProgressBar && timerControls) {
                timerProgressBar.style.display = 'none';
                timerControls.style.display = 'none';
            }
        }

        function toggleTimer() {
            isTimerPaused = !isTimerPaused;
            const timerButton = document.querySelector('.timer-controls button');
            if (timerButton) {
                timerButton.textContent = isTimerPaused ? 'Retomar' : 'Pausar';
            }
        }

        function renderScores() {
            const tableBody = document.querySelector('#score-table tbody');
            const level = document.getElementById('level');
            const levelProgress = document.getElementById('level-progress');
            if (!tableBody || !level || !levelProgress) return;

            tableBody.innerHTML = '';
            let labels = [];
            let data = [];
            let totalCorrect = 0;
            let totalQuestions = 0;

            if (scores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">Nenhum progresso registrado.</td></tr>';
            } else {
                scores.forEach((s, i) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${s.quiz}</td>
                        <td>${s.score}</td>
                        <td>${s.total}</td>
                        <td>${s.xp} XP</td>
                    `;
                    tableBody.appendChild(row);
                    labels.push(s.quiz);
                    data.push((s.score / s.total) * 100);
                    totalCorrect += s.score;
                    totalQuestions += s.total;
                });
            }

            level.textContent = currentLevel;
            const xpForPreviousLevels = JSON.parse(localStorage.getItem('xpForPreviousLevels')) || 0;
            const nextLevelXP = settings.baseXPToLevelUp + currentLevel * settings.xpIncrementPerLevel;
            const currentLevelXP = totalXP - xpForPreviousLevels;
            const progress = currentLevelXP / nextLevelXP * 100;
            levelProgress.style.width = `${Math.min(progress, 100)}%`;

            const ctxPie = document.getElementById('pieChart')?.getContext('2d');
            if (ctxPie) {
                if (pieChartInstance) pieChartInstance.destroy();
                pieChartInstance = new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: ['Acertos', 'Erros'],
                        datasets: [{
                            data: totalQuestions > 0 ? [totalCorrect, totalQuestions - totalCorrect] : [1, 0],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: ['#fff', '#fff'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Acertos e Erros'
                            }
                        }
                    }
                });
            }

            const ctxLine = document.getElementById('lineChart')?.getContext('2d');
            if (ctxLine) {
                if (lineChartInstance) lineChartInstance.destroy();
                lineChartInstance = new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: labels.length > 0 ? labels : ['Nenhum dado'],
                        datasets: [{
                            label: '% Acertos por Quest',
                            data: labels.length > 0 ? data : [0],
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Porcentagem de Acertos'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Quests'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Progresso por Quest'
                            }
                        }
                    }
                });
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const themeIcon = document.querySelector('.theme-btn i');
            if (themeIcon) {
                themeIcon.className = document.body.classList.contains('light-theme') ? 'fas fa-moon' : 'fas fa-sun';
            }
            updateHPBar();
        }

        function resetScores() {
            scores = [];
            currentHP = settings.maxHP;
            currentLevel = 0;
            totalXP = 0;
            isGameOver = false;
            wrongQuestions = [];
            localStorage.setItem('rpgScores', JSON.stringify(scores));
            localStorage.setItem('currentHP', JSON.stringify(currentHP));
            localStorage.setItem('currentLevel', JSON.stringify(currentLevel));
            localStorage.setItem('totalXP', JSON.stringify(totalXP));
            localStorage.setItem('xpForPreviousLevels', JSON.stringify(0));
            localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
            renderScores();
            updateHPBar();
            updateStartButton();
        }

        function deleteAllQuestions() {
            if (confirm('Tem certeza que deseja apagar todas as questões? Esta ação não pode be desfeita.')) {
                questionBank = [];
                wrongQuestions = [];
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                currentPage = 1;
                renderQuestionBank();
                alert('Todas as questões foram apagadas.');
                updateStartButton();
            }
        }

        function showSaveSlots() {
            const saveSlotSection = document.getElementById('save-slot-section');
            saveSlotSection.style.display = 'flex';
            renderSaveSlots(true);
        }
        function showLoadSlots() {
            const saveSlotSection = document.getElementById('save-slot-section');
            saveSlotSection.style.display = 'flex';
            renderSaveSlots(false);
        }
        
        function renderSaveSlots(isSaveMode) {
            const saveSlotSection = document.getElementById('save-slot-section');
            saveSlotSection.innerHTML = '';
        
            for (let i = 0; i < 8; i++) {
                const slot = savedGames[i];
                const card = document.createElement('div');
                card.classList.add('save-slot-card');
                if (!slot) {
                    card.classList.add('empty');
                    card.innerHTML = `<p>Slot ${i + 1} - Vazio</p>`;
                    if (isSaveMode) {
                        card.addEventListener('click', () => saveGame(i));
                    }
                } else {
                    card.innerHTML = `
                        <p>Slot ${i + 1}</p>
                        <p>Nível: ${slot.level}</p>
                        <p>HP: ${slot.hp}/${slot.maxHP}</p>
                        <p>XP Total: ${slot.totalXP}</p>
                        <p>Quests: ${slot.scores.length}</p>
                        <button class="delete-slot-btn" onclick="deleteGame(${i}); event.stopPropagation();"><i class="fas fa-trash"></i></button>
                    `;
                    if (!isSaveMode) {
                        card.addEventListener('click', () => loadGame(i));
                    }
                }
                saveSlotSection.appendChild(card);
            }
        }
        
        function saveGame(slot) {
            if (isGameOver) {
                alert('Não é possível salvar o jogo em estado de Game Over.');
                return;
            }
            try {
                let totalCorrect = 0;
                let totalQuestions = 0;
                scores.forEach(s => {
                    totalCorrect += s.score;
                    totalQuestions += s.total;
                });
                savedGames[slot] = {
                    level: currentLevel,
                    hp: currentHP,
                    maxHP: settings.maxHP,
                    totalXP: totalXP,
                    scores: scores,
                    wrongQuestions: wrongQuestions,
                    questionBank: questionBank,
                    chartData: {
                        pie: {
                            correct: totalCorrect,
                            total: totalQuestions
                        },
                        line: {
                            labels: scores.map(s => s.quiz),
                            data: scores.map(s => (s.score / s.total) * 100)
                        }
                    }
                };
                localStorage.setItem('savedGames', JSON.stringify(savedGames));
                alert(`Jogo salvo no slot ${slot + 1}!`);
                document.getElementById('save-slot-section').style.display = 'none';
                renderSaveSlots(true);
                renderScores();
            } catch (e) {
                console.error('Erro ao salvar o jogo:', e);
                alert('Erro ao salvar o jogo. Verifique se o armazenamento local está disponível ou tente novamente.');
            }
        }

        function loadGame(slot) {
            const game = savedGames[slot];
            if (game) {
                currentLevel = game.level;
                currentHP = game.hp;
                settings.maxHP = game.maxHP;
                totalXP = game.totalXP;
                scores = game.scores;
                wrongQuestions = game.wrongQuestions;
                questionBank = game.questionBank || questionBank; // Carrega questionBank, se disponível
                isGameOver = currentHP <= 0;
                localStorage.setItem('currentLevel', JSON.stringify(currentLevel));
                localStorage.setItem('currentHP', JSON.stringify(currentHP));
                localStorage.setItem('totalXP', JSON.stringify(totalXP));
                localStorage.setItem('rpgScores', JSON.stringify(scores));
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                localStorage.setItem('settings', JSON.stringify(settings));
                updateHPBar();
                updateStartButton();
                renderScores();
                alert(`Jogo carregado do slot ${slot + 1}!`);
                document.getElementById('save-slot-section').style.display = 'none';
            }
        }

        function deleteGame(slot) {
            if (confirm(`Tem certeza que deseja excluir o jogo salvo no slot ${slot + 1}?`)) {
                try {
                    savedGames[slot] = null; // Remove o jogo do slot
                    localStorage.setItem('savedGames', JSON.stringify(savedGames));
                    renderSaveSlots(document.getElementById('save-slot-section').style.display === 'flex'); // Re-renderiza os slots
                    alert(`Jogo no slot ${slot + 1} excluído com sucesso!`);
                } catch (e) {
                    console.error('Erro ao excluir o jogo:', e);
                    alert('Erro ao excluir o jogo. Verifique se o armazenamento local está disponível ou tente novamente.');
                }
            }
        }

        function addQuestion(event) {
            event.preventDefault();
            const questionText = document.getElementById('question-text').value;
            const optionA = document.getElementById('option-a').value;
            const optionB = document.getElementById('option-b').value;
            const optionC = document.getElementById('option-c').value;
            const optionD = document.getElementById('option-d').value;
            const correctAnswer = document.getElementById('correct-answer').value;

            if (questionText && optionA && optionB && optionC && optionD && correctAnswer) {
                const newQuestion = {
                    text: questionText,
                    options: [optionA, optionB, optionC, optionD],
                    answer: correctAnswer
                };
                questionBank.push(newQuestion);
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                alert('Questão adicionada com sucesso!');
                document.getElementById('add-question-form').reset();
            } else {
                alert('Por favor, preencha todos os campos.');
            }
        }

        function renderQuestionBank() {
            const bankList = document.getElementById('question-bank-list');
            const pagination = document.getElementById('pagination');
            if (!bankList || !pagination) {
                console.error('Elementos DOM não encontrados:', { bankList, pagination });
                return;
            }
        
            // Calcula o número total de páginas
            const totalPages = Math.max(1, Math.ceil(questionBank.length / questionsPerPage));
        
            // Valida currentPage para evitar índices inválidos
            if (questionBank.length === 0) {
                currentPage = 1;
            } else if (currentPage < 1) {
                currentPage = 1;
            } else if (currentPage > totalPages) {
                currentPage = totalPages;
            }
        
            // Limpa a lista de questões
            bankList.innerHTML = '';
            const start = (currentPage - 1) * questionsPerPage;
            const end = Math.min(start + questionsPerPage, questionBank.length);
            const paginatedQuestions = questionBank.slice(start, end);
        
            // Renderiza as questões paginadas
            if (paginatedQuestions.length === 0) {
                bankList.innerHTML = '<p>Nenhuma questão disponível.</p>';
            } else {
                paginatedQuestions.forEach((q, i) => {
                    const globalIndex = start + i;
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question-card');
                    questionDiv.innerHTML = `
                        <h3>${globalIndex + 1}. ${q.text}</h3>
                        <div class="options">
                            <p>A) ${q.options[0]}</p>
                            <p>B) ${q.options[1]}</p>
                            <p>C) ${q.options[2]}</p>
                            <p>D) ${q.options[3]}</p>
                            <p><strong>Resposta:</strong> ${q.answer}</p>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" onclick="editQuestion(${globalIndex})">Editar</button>
                            <button class="delete-btn" onclick="deleteQuestion(${globalIndex})">Excluir</button>
                        </div>
                    `;
                    bankList.appendChild(questionDiv);
                });
            }
        
            // Limpa a paginação
            pagination.innerHTML = '';
        
            // Configurações para a paginação
            const maxButtons = 5; // Máximo de botões numéricos exibidos
            const halfMaxButtons = Math.floor(maxButtons / 2);
            let startPage = Math.max(1, currentPage - halfMaxButtons);
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        
            // Ajusta startPage se endPage ultrapassar totalPages
            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
        
            // Adiciona botão "Primeira"
            if (totalPages > maxButtons && currentPage > 1) {
                const firstButton = document.createElement('button');
                firstButton.textContent = '«';
                firstButton.title = 'Primeira página';
                firstButton.addEventListener('click', () => {
                    currentPage = 1;
                    renderQuestionBank();
                });
                pagination.appendChild(firstButton);
            }
        
            // Adiciona botão "Anterior"
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderQuestionBank();
                }
            });
            pagination.appendChild(prevButton);
        
            // Adiciona elipse inicial se necessário
            if (startPage > 1) {
                const ellipsisStart = document.createElement('button');
                ellipsisStart.textContent = '...';
                ellipsisStart.disabled = true;
                pagination.appendChild(ellipsisStart);
            }
        
            // Adiciona botões numéricos
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.toggle('active', i === currentPage);
                button.addEventListener('click', () => {
                    currentPage = i;
                    renderQuestionBank();
                });
                pagination.appendChild(button);
            }
        
            // Adiciona elipse final se necessário
            if (endPage < totalPages) {
                const ellipsisEnd = document.createElement('button');
                ellipsisEnd.textContent = '...';
                ellipsisEnd.disabled = true;
                pagination.appendChild(ellipsisEnd);
            }
        
            // Adiciona botão "Próxima"
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Próxima';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderQuestionBank();
                }
            });
            pagination.appendChild(nextButton);
        
            // Adiciona botão "Última"
            if (totalPages > maxButtons && currentPage < totalPages) {
                const lastButton = document.createElement('button');
                lastButton.textContent = '»';
                lastButton.title = 'Última página';
                lastButton.addEventListener('click', () => {
                    currentPage = totalPages;
                    renderQuestionBank();
                });
                pagination.appendChild(lastButton);
            }
        }

        function editQuestion(index) {
            const editSection = document.getElementById('edit-question-section');
            const addSection = document.getElementById('add-question-section');
            const bankSection = document.getElementById('question-bank-section');
            const importSection = document.getElementById('import-question-section');
            const exportSection = document.getElementById('export-question-section');
        
            if (editSection && addSection && bankSection && importSection && exportSection) {
                editSection.style.display = 'block';
                addSection.style.display = 'none';
                bankSection.style.display = 'none';
                importSection.style.display = 'none';
                exportSection.style.display = 'none';
        
                const question = questionBank[index];
                document.getElementById('edit-question-index').value = index;
                document.getElementById('edit-question-text').value = question.text;
                document.getElementById('edit-option-a').value = question.options[0];
                document.getElementById('edit-option-b').value = question.options[1];
                document.getElementById('edit-option-c').value = question.options[2];
                document.getElementById('edit-option-d').value = question.options[3];
                document.getElementById('edit-correct-answer').value = question.answer;
            }
        }


        function saveEditedQuestion(event) {
            event.preventDefault();
            const index = document.getElementById('edit-question-index').value;
            const questionText = document.getElementById('edit-question-text').value;
            const optionA = document.getElementById('edit-option-a').value;
            const optionB = document.getElementById('edit-option-b').value;
            const optionC = document.getElementById('edit-option-c').value;
            const optionD = document.getElementById('edit-option-d').value;
            const correctAnswer = document.getElementById('edit-correct-answer').value;

            if (questionText && optionA && optionB && optionC && optionD && correctAnswer) {
                questionBank[index] = {
                    text: questionText,
                    options: [optionA, optionB, optionC, optionD],
                    answer: correctAnswer
                };
                // Update wrongQuestions if the edited question exists there
                const wrongIndex = wrongQuestions.findIndex(wq => wq.text === questionBank[index].text && wq.options.join() === questionBank[index].options.join());
                if (wrongIndex !== -1) {
                    wrongQuestions[wrongIndex] = questionBank[index];
                    localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                }
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                alert('Questão atualizada com sucesso!');
                toggleQuestionsMode('bank');
            } else {
                alert('Por favor, preencha todos os campos.');
            }
        }

        function deleteQuestion(index) {
            if (confirm('Tem certeza que deseja excluir esta questão?')) {
                const wrongIndex = wrongQuestions.findIndex(wq =>
                    wq.text === questionBank[index].text &&
                    wq.options.join() === questionBank[index].options.join() &&
                    wq.answer === questionBank[index].answer
                );
                if (wrongIndex !== -1) {
                    wrongQuestions.splice(wrongIndex, 1);
                    localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                }
                questionBank.splice(index, 1);
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                // Ajusta currentPage se necessário
                const totalPages = Math.max(1, Math.ceil(questionBank.length / questionsPerPage));
                if (currentPage > totalPages) {
                    currentPage = totalPages;
                }
                renderQuestionBank();
                updateStartButton();
            }
        }

        function displayFileName() {
            const fileInput = document.getElementById('question-file');
            const fileNameDisplay = document.getElementById('file-name-display');
            if (fileInput && fileNameDisplay) {
                fileNameDisplay.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Nenhum arquivo selecionado';
            }
        }

        function importQuestions(event) {
            event.preventDefault();
            const fileInput = document.getElementById('question-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecione um arquivo Excel.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (json.length < 2) {
                    alert('A planilha está vazia ou não contém dados válidos.');
                    return;
                }

                const headers = json[0];
                const expectedHeaders = ['Questão', 'Alternativa A', 'Alternativa B', 'Alternativa C', 'Alternativa D', 'Alternativa Correta'];
                if (!headers.every((h, i) => h === expectedHeaders[i])) {
                    alert('O formato da planilha está incorreto. Use o modelo fornecido.');
                    return;
                }

                const newQuestions = json.slice(1).filter(row => row.length >= 6).map(row => ({
                    text: row[0],
                    options: [row[1], row[2], row[3], row[4]],
                    answer: row[5]
                })).filter(q => q.text && q.options.every(opt => opt) && ['A', 'B', 'C', 'D'].includes(q.answer));

                if (newQuestions.length === 0) {
                    alert('Nenhuma questão válida encontrada na planilha.');
                    return;
                }

                questionBank.push(...newQuestions);
                localStorage.setItem('questionBank', JSON.stringify(questionBank));
                alert(`${newQuestions.length} questão(ões) importada(s) com sucesso!`);
                document.getElementById('import-question-form').reset();
                displayFileName();
                toggleQuestionsMode('bank');
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadTemplate() {
            const ws_data = [
                ['Questão', 'Alternativa A', 'Alternativa B', 'Alternativa C', 'Alternativa D', 'Alternativa Correta'],
                ['Exemplo 1', 'Opção A', 'Opção B', 'Opção C', 'Opção D', 'A']
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Modelo');
            XLSX.writeFile(wb, 'modelo_questoes.xlsx');
        }

        function exportQuestions() {
            const ws_data = [
                ['Questão', 'Alternativa A', 'Alternativa B', 'Alternativa C', 'Alternativa D', 'Alternativa Correta']
            ];
            questionBank.forEach(q => {
                ws_data.push([q.text, q.options[0], q.options[1], q.options[2], q.options[3], q.answer]);
            });
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Questões');
            XLSX.writeFile(wb, 'banco_questoes.xlsx');
        }

        updateLevelAndHP();
        updateHPBar();
        updateStartButton();
        const addQuestionForm = document.getElementById('add-question-form');
        const editQuestionForm = document.getElementById('edit-question-form');
        const importQuestionForm = document.getElementById('import-question-form');
        const settingsForm = document.getElementById('settings-form');
        const fileInput = document.getElementById('question-file');
        const difficultyButtons = document.querySelectorAll('.difficulty-button');
        const quizForm = document.getElementById('quiz-form');

        if (addQuestionForm) {
            addQuestionForm.addEventListener('submit', addQuestion);
        }
        if (editQuestionForm) {
            editQuestionForm.addEventListener('submit', saveEditedQuestion);
        }
        if (importQuestionForm) {
            importQuestionForm.addEventListener('submit', importQuestions);
        }
        if (settingsForm) {
            settingsForm.addEventListener('submit', saveSettings);
        }
        if (fileInput) {
            fileInput.addEventListener('change', displayFileName);
        }
        if (difficultyButtons) {
            difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    document.getElementById('difficulty').value = button.dataset.difficulty;
                    updateDifficulty();
                    updateDifficultyButtons();
                });
            });
        }
        if (quizForm) {
            quizForm.addEventListener('submit', submitQuiz);
        }

        loadSettings();
    </script>
</body>
</html>